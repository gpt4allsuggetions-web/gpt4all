<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPT4ALL - Token Dashboard</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
  <style>
    body { font-family:'Inter',sans-serif; background:#121212; color:#e5e5e5; display:flex; min-height:100vh; margin:0; transition:margin-left 0.3s ease; }
    #sidebar { width:220px; background:#1e1e1e; border-right:1px solid #2a2a2a; padding:20px 0; position:fixed; top:0; bottom:0; left:0; transition:transform 0.3s ease; z-index:1000; }
    #sidebar h2 { text-align:center; color:#00bcd4; margin-bottom:20px; }
    #sidebar ul { list-style:none; margin:0; padding:0; }
    #sidebar ul li { padding:10px 20px; cursor:pointer; color:#ccc; }
    #sidebar ul li:hover { background:#2a2a2a; color:#00bcd4; }
    #sidebar ul li a { color:inherit; text-decoration:none; display:block; }

    main { margin-left:220px; flex-grow:1; padding:16px; display:flex; flex-direction:column; transition:margin-left 0.3s ease; }
    header { background:#1a1a1a; padding:8px 16px; display:flex; justify-content:space-between; align-items:center; border:1px solid #2a2a2a; border-radius:6px; }
    header button { background:none; border:none; color:#00bcd4; font-size:22px; cursor:pointer; margin-right:10px; }

    /* collapsed state (desktop toggle) */
    body.collapsed #sidebar { transform:translateX(-220px); }
    body.collapsed main { margin-left:0; }

    /* mobile mode */
    @media (max-width: 768px) {
      #sidebar { transform:translateX(-220px); } /* hidden by default */
      body.show-sidebar #sidebar { transform:translateX(0); }
      main { margin-left:0; }
      #overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:900; }
      body.show-sidebar #overlay { display:block; }
    }

    .chat-box { flex-grow:1; margin-top:16px; background:#1a1a1a; border:1px solid #2a2a2a; border-radius:8px; padding:16px; overflow-y:auto; }
    .message { margin:6px 0; padding:8px 12px; border-radius:6px; max-width:70%; word-wrap:break-word; }
    .user-msg { background:#004d61; margin-left:auto; color:#e0f7fa; }
    .gpt-msg { background:#2a2a2a; color:#e5e5e5; margin-right:auto; }
    .input-panel { display:flex; margin-top:14px; background:#1e1e1e; border:1px solid #2a2a2a; border-radius:8px; }
    .input-panel textarea { flex-grow:1; padding:12px; border:none; outline:none; resize:none; background:transparent; color:#e5e5e5; }
    .input-panel button { padding:0 16px; background:#00bcd4; border:none; color:#121212; font-weight:600; cursor:pointer; border-radius:0 8px 8px 0; }
    .input-panel button:hover { background:#00a3bb; }
    .panel-row { display:flex; gap:12px; margin-top:14px; flex-wrap:wrap; }
    .card { flex:1; background:#1e1e1e; border:1px solid #2a2a2a; border-radius:8px; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; min-width:200px; }
    .card button { padding:6px 12px; background:#00bcd4; border:none; color:#121212; font-weight:600; cursor:pointer; border-radius:6px; }
    .card button:hover { background:#00a3bb; }
  </style>
</head>
<body>

<div id="overlay"></div>

<aside id="sidebar">
  <h2>GPT4ALL</h2>
  <ul>
    <li><a href="main.html">New Chat</a></li>
    <li><a href="history.html">History</a></li>
    <li><a href="faq1.html">FAQ</a></li>
    <li><a href="contact1.html">Contact</a></li>
    <li><a href="settings.html">Settings</a></li>
    <li><a href="about1.html">About</a></li>
  </ul>
</aside>

<main>
  <header>
    <div style="display:flex;align-items:center;">
      <button id="toggleSidebar">☰</button>
      <h1>Dashboard</h1>
    </div>
    <span>Tokens: <strong id="tokens">loading...</strong></span>
  </header>

  <div class="chat-box" id="chatBox"></div>

  <div class="input-panel">
    <textarea id="userInput" rows="2" placeholder="Type your message..."></textarea>
    <button id="sendBtn">Send</button>
  </div>

  <div class="panel-row">
    <div class="card">
      <span>Message cost: <strong id="liveCost">0</strong> tokens</span>
    </div>
    <div class="card">
      <span>Need more tokens?</span>
      <button id="watchAd">Watch Ad +500</button>
    </div>
  </div>
</main>

<script>
  const chatBox = document.getElementById("chatBox");
  const userInput = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const tokensEl = document.getElementById("tokens");
  const liveCost = document.getElementById("liveCost");
  const watchAd = document.getElementById("watchAd");
  const toggleSidebar = document.getElementById("toggleSidebar");
  const overlay = document.getElementById("overlay");

  const userId = localStorage.getItem("userId"); // check login

  // 🚨 Redirect if not logged in
  if (!userId) {
    window.location.href = "index.html";
  }

  // toggle sidebar
  toggleSidebar.addEventListener("click", () => {
    if (window.innerWidth <= 768) {
      document.body.classList.toggle("show-sidebar");
    } else {
      document.body.classList.toggle("collapsed");
    }
  });

  overlay.addEventListener("click", () => {
    document.body.classList.remove("show-sidebar");
  });

  // live token cost (1 token = 4 chars)
  userInput.addEventListener("input", () => {
    const chars = userInput.value.length;
    liveCost.textContent = String(Math.ceil(chars / 4));
  });

  function addMessage(text, sender="user") {
    const msg = document.createElement("div");
    msg.className = `message ${sender}-msg`;
    msg.textContent = (sender==="user" ? "You: " : "Bot: ") + text;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function sendMessage() {
    const msg = userInput.value.trim();
    if (!msg) return;
    addMessage(msg,"user");
    userInput.value = "";
    liveCost.textContent = "0";

    try {
      const res = await fetch("http://localhost:3000/api/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: msg, userId })
      });
      const data = await res.json();

      if (data.error) {
        addMessage("⚠️ " + data.error,"gpt");
      } else {
        addMessage(data.reply,"gpt");
        tokensEl.textContent = data.tokens;
      }
    } catch (err) {
      addMessage("⚠️ Server not available.","gpt");
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  userInput.addEventListener("keypress", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  watchAd.addEventListener("click", async () => {
    try {
      const res = await fetch("http://localhost:3000/api/addTokens", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ userId, amount:500 })
      });
      const data = await res.json();
      tokensEl.textContent = data.tokens;
      alert("You earned 500 tokens!");
    } catch {
      alert("⚠️ Could not connect to server.");
    }
  });

  // load balance
  fetch("http://localhost:3000/api/balance?userId="+userId)
    .then(r=>r.json())
    .then(d=> tokensEl.textContent = d.tokens)
    .catch(()=> tokensEl.textContent = "0");
</script>
</body>
</html>
